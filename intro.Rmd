---
output:
  pdf_document: default
  html_document: default
---

Este proyecto nace como un instrumento para poder aplicar los contenidos aprendidos durante el semestre en un problema real. Se tendrá que demostrar los conocimentos adquiridos al realizar un analisis exploratorio sobre datos de interes nacional, poniendo especial énfasis en la correcta visualización de los resultados obtenidos, realizando una correcta interpretación de la misma. 
En el caso de este grupo en cuestión, se analizarán datos de incautaciones de aduana presentados por la Dirección Nacional de Aduanas, que fueron elegidos  Para llevar a cabo estos objetivos, se utilizará exclusivamente el lenguaje de programación R, y sus respectivas expansiones, como Markdown, Shiny y RStudio.


```{r,echo=FALSE}

library(tidyverse)
library(readr)
datos <- read_rds(here('data','raw','datos.rds'))
                                                                                                                                                                                                                                                                
dim(datos)

```

Los datos  fueron obtenidos en el catalogo de datos abiertos que puso a disposición el gobierno uruguayo. Más específicamente estos fueron subidos por la Dirección Nacional de Aduanas. Cuentan con 16 variables y 76.792 observaciones. Tres de las varibles son de tipo double, mientras que las restantes son de tipo caracter. 

```{r,echo=FALSE}

datos <- datos %>%
  
            rename(fecha_incautacion = TIEM_DIA_SK_INCAUTACION ,
                   aduana = ADUA_ADUA_DESCC , 
                   infraccion = INFR_INFR_DESCC ,
                   pais_procedencia = PAIS_PAIS_DESCC_PAIS_PROCEDENC ,
                   unidad = UCOM_UCOM_DESCC ,
                   estado_incautacion = ESTINC_ESTINC_DESCC ,
                   tipo = TINC_TINC_DESCC ,
                   cantidad = INC_CANTIDAD ,
                   valor = INC_VALOR_MN) %>%
  
            select(fecha_incautacion,
                   aduana,
                   infraccion,
                   pais_procedencia,
                   unidad,
                   estado_incautacion,
                   tipo,
                   cantidad,
                   valor) 

glimpse(datos)

```

```{r,echo=FALSE}

#cambiar tildes y ñ
# 
# lapply(datos, gsub, pattern = "Á", replacement = "A")
# lapply(datos, gsub, pattern = "É", replacement = "E")
# lapply(datos, gsub, pattern = "Í", replacement = "I")
# lapply(datos, gsub, pattern = "Ó", replacement = "O")
# lapply(datos, gsub, pattern = "Ú", replacement = "U")
# lapply(datos, gsub, pattern = "Ñ", replacement = "N")

library(data.table)

datos <- as.data.table(datos)
datos <- datos[, lapply(.SD, iconv, "latin1", "UTF-8")]

```

Para realizar la exploración, nos planteamos algunas preguntas para orientar el análisis. En primer lugar, decidimos investigar de qué manera había evolucionado la cantidad total de incautaciones durante el período en cuestión, teniendo en cuenta las diferentes infracciones que se pueden realizar.

```{r,echo=FALSE,fig.cap="Se puede ver un aumento en la cantidad de incautaciones en el correr del año con un gran descenso en el verano diciembre-enero, puede deberse a un menor control aduanero y un enfoque en el turismo, o por un menor comercio en esta época. Se puede ver también como el covid no disminuyó las incautaciones"}
library(ggpmisc)
library(lubridate)
datos %>% mutate(fecha=ym(fecha_incautacion)) %>% group_by(fecha) %>% summarise(conteo=n()) %>% ggplot(aes(x=fecha,y=conteo))+geom_line()+stat_peaks()+stat_peaks(geom="text",color="black",vjust=-0.3)+labs(x="Fecha de la incautación",y="Cantidad de incautaciones")
```
```{r,echo=FALSE,fig.cap="Los bajos datos del año 2021 se debe a que los datos llegan solo hasta mitad de año. Existe un claro aumento desde el 2018 a 2019 en todos los tipos de incautaciones, puede ser por un mayor control en las aduanas o un cambio de politica, hay un gran pico de falsificaciones en 2019, mientras que en el 2020 los otros tipos de incautaciones frecuentaron más"}
datos %>% separate(fecha_incautacion, into=c("anio","mes"),sep=4) %>%group_by(infraccion,anio) %>% summarise(conteo=n()) %>% ggplot(aes(x=anio,y=conteo))+geom_col()+facet_wrap(~infraccion,scales="free")+labs(x="Año",y="Cantidad")
```

Luego decidimos analizar más en profundidad la variable "Valor", que indica el valor de la incautación realizada en cada caso. Para hacer esto, iniciamos observando la distribución de la variable, para luego adentrarnos en la relación que tiene el valor (medido en pesos) con la cantidad de incautaciones incautadas.

```{r,echo=FALSE,fig.cap="Se puede observar una clara relación entre el valor y la cantidad, dado que la mayoria de las incautaciones son de un bajo valor"}
datos %>% filter(as.numeric(valor)<atipicovalor) %>%ggplot(aes(x=as.numeric(valor)))+geom_histogram(bins=30)+labs(x="Valor en U$",y="Cantidad de incautaciones")
```

```{r,echo=FALSE,fig.cap="Se observa una correlacion casi nula entre las variables y una clara tendencia a que las incauaciones sean de bajo valor y cantidad"}
atipicovalor<-quantile(as.numeric(datos$valor),probs=0.75)+1.5*(quantile(as.numeric(datos$valor),probs=0.75)-quantile(as.numeric(datos$valor),probs=0.25))

atipicocantidad<-quantile(as.numeric(datos$cantidad),probs=0.75)+1.5*(quantile(as.numeric(datos$cantidad),probs=0.75)-quantile(as.numeric(datos$cantidad),probs=0.25))

datos %>% mutate(cantidad=round(as.numeric(cantidad),0),valor=round(as.numeric(valor),0))%>% filter(valor<atipicovalor)%>% filter(cantidad<atipicocantidad)%>% ggplot(aes(x=valor,y=cantidad))+geom_point(alpha=1/8,size=1)+theme(aspect.ratio = 1)+labs(x="Valor en U$",y="Cantidad")
```
```{r,echo=FALSE,fig.cap=}
cor(as.numeric(datos$cantidad),as.numeric(datos$valor))
```

A continuación nos enfocamos en la variable "aduana", que hace referencia al lugar dentro del Uruguay que se realizó el acto de incautar. Como primer paso se investigó de que manera se distribuyen las incautaciones totales dentro del territorio nacional. Sucesivamente, nos interesó saber el destino de cada uno de estos actos, sabiendo también el origen.

```{r,echo=FALSE,fig.cap="Hay una clara mayor cantidad de incautaciones en las aduanas del este y norte, se debe al mercado con el pais froterizo Brasil, el cual se diferencia claramente de las aduanas del oeste"}
datos%>%
  select(aduana)%>%
  mutate(aduana = recode(aduana, `SEDE REGIONAL SUROESTE(BAJA)` = "SEDE SUDOESTE",
`SEDE REGIONAL LITORAL NORESTE(BAJA)`= "SEDE NORESTE",`SEDE REGIONAL OESTE(ANTES NOROESTE)` = "SEDE OESTE")) %>%
  group_by(aduana) %>%
  summarise(conteo=n()) %>% ggplot(aes(x=fct_reorder(aduana,conteo),y=conteo))+geom_col()+theme(axis.text.x = element_text(angle = 90, vjust=0.5, size = 8))+labs(y='Cantidad de incautaciones',x='Aduana')
```
```{r,echo=FALSE,fig.cap=}
tabla2 <- subset(data.frame( table(datos$aduana)))
aduanas <- subset(datos, aduana %in% tabla2$Var1)
tabla2<- data.frame( with(aduanas, table(pais_procedencia, aduana) ) )
ggplot(tabla2) + geom_tile(aes(x=pais_procedencia, y=aduana, fill=Freq))+ theme(axis.text.x = element_text(angle = 90, vjust=0.5, size = 8))+scale_fill_gradient(low="white",high="black")+labs(x="Pais de procedencia",y="Aduana")
```

Como último objetivo, decidimos investigar el estado en el que se encuantra cada incautación, intentando observar cuál infracción demora más tiempo en resolverse.
```{r,echo=FALSE,fig.cap=}
datos %>% group_by(infraccion,estado_incautacion) %>% summarise(conteo=n())
tabla<-data.frame(estado=c("Contencioso Final","Contencioso Inicial","Falsificacion","Ingresado","Valorador","Contencioso Final","Contencioso Inicial","Falsificacion","Ingresado","Valorador","Contencioso Final","Contencioso Inicial","Falsificacion","Ingresado","Valorador","Contencioso Final","Contencioso Inicial","Falsificacion","Ingresado","Valorador"),infraccion=c("Abandono","Abandono","Abandono","Abandono","Abandono","Contrabando","Contrabando","Contrabando","Contrabando","Contrabando","Falsificacion","Falsificacion","Falsificacion","Falsificacion","Falsificacion","Receptacion","Receptacion","Receptacion","Receptacion","Receptacion"),Freq=c(17362,399,365,438,2,54169,2090,1004,416,314,101,0,3,0,0,129,0,0,0,0))
ggplot(tabla,aes(x=estado,y=infraccion,fill=Freq))+geom_tile()+scale_fill_gradient(low="grey",high="blue")+geom_text(aes(label=Freq))
```

Shiny


Conlusiones finales